<div class="form-container">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon class="header-icon">folder</mat-icon>
        {{ isEditMode() ? 'Editar' : 'Novo' }} Caso Clínico
      </mat-card-title>
      <mat-card-subtitle>
        {{ isEditMode() ? 'Edite as informações do caso clínico' : 'Crie um novo caso clínico para o site' }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="caseForm" (ngSubmit)="onSubmit()">
        
        <!-- Informações Básicas -->
        <div class="section">
          <h3 class="section-title">
            <mat-icon>info</mat-icon>
            Informações Básicas
          </h3>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-70">
              <mat-label>Título</mat-label>
              <input matInput formControlName="title" placeholder="Ex: Restauração em Porcelana" />
              @if (caseForm.get('title')?.hasError('required')) {
                <mat-error>Título é obrigatório</mat-error>
              }
              @if (caseForm.get('title')?.hasError('maxlength')) {
                <mat-error>Título deve ter no máximo 200 caracteres</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-30">
              <mat-label>Ordem de Exibição</mat-label>
              <input matInput type="number" formControlName="order" placeholder="1, 2, 3..." />
              @if (caseForm.get('order')?.hasError('required')) {
                <mat-error>Ordem é obrigatória</mat-error>
              }
              @if (caseForm.get('order')?.hasError('min')) {
                <mat-error>Ordem deve ser maior que zero</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Descrição Curta (Homepage)</mat-label>
              <textarea 
                matInput 
                formControlName="shortDescription" 
                rows="3"
                placeholder="Descrição breve que aparecerá na homepage...">
              </textarea>
              @if (caseForm.get('shortDescription')?.hasError('required')) {
                <mat-error>Descrição curta é obrigatória</mat-error>
              }
              @if (caseForm.get('shortDescription')?.hasError('maxlength')) {
                <mat-error>Descrição curta deve ter no máximo 500 caracteres</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Descrição Completa</mat-label>
              <textarea 
                matInput 
                formControlName="fullDescription" 
                rows="6"
                placeholder="Descrição detalhada do caso clínico...">
              </textarea>
              @if (caseForm.get('fullDescription')?.hasError('required')) {
                <mat-error>Descrição completa é obrigatória</mat-error>
              }
              @if (caseForm.get('fullDescription')?.hasError('maxlength')) {
                <mat-error>Descrição completa deve ter no máximo 2000 caracteres</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Imagem Principal -->
        <div class="section">
          <h3 class="section-title">
            <mat-icon>image</mat-icon>
            Imagem Principal
          </h3>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>URL da Imagem Principal</mat-label>
              <input matInput formControlName="mainImageUrl" placeholder="https://exemplo.com/imagem.jpg" />
              @if (caseForm.get('mainImageUrl')?.hasError('required')) {
                <mat-error>URL da imagem principal é obrigatória</mat-error>
              }
            </mat-form-field>
          </div>

          @if (caseForm.get('mainImageUrl')?.value) {
            <div class="image-preview">
              <div class="image-container">
                <img 
                  [src]="caseForm.get('mainImageUrl')?.value" 
                  alt="Imagem principal"
                  class="preview-image">
                <button 
                  type="button"
                  class="remove-image-btn"
                  (click)="clearMainImage()"
                  [title]="'Remover imagem'">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>
          }
        </div>

        <!-- Detalhes do Caso -->
        <div class="section">
          <h3 class="section-title">
            <mat-icon>description</mat-icon>
            Detalhes do Caso
          </h3>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Materiais Utilizados</mat-label>
              <textarea 
                matInput 
                formControlName="materials" 
                rows="3"
                placeholder="Liste os materiais utilizados no tratamento...">
              </textarea>
              @if (caseForm.get('materials')?.hasError('required')) {
                <mat-error>Materiais são obrigatórios</mat-error>
              }
              @if (caseForm.get('materials')?.hasError('maxlength')) {
                <mat-error>Materiais devem ter no máximo 1000 caracteres</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Procedimento Realizado</mat-label>
              <textarea 
                matInput 
                formControlName="procedure" 
                rows="4"
                placeholder="Descreva o procedimento realizado...">
              </textarea>
              @if (caseForm.get('procedure')?.hasError('required')) {
                <mat-error>Procedimento é obrigatório</mat-error>
              }
              @if (caseForm.get('procedure')?.hasError('maxlength')) {
                <mat-error>Procedimento deve ter no máximo 2000 caracteres</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Resultados Obtidos</mat-label>
              <textarea 
                matInput 
                formControlName="results" 
                rows="3"
                placeholder="Descreva os resultados obtidos...">
              </textarea>
              @if (caseForm.get('results')?.hasError('required')) {
                <mat-error>Resultados são obrigatórios</mat-error>
              }
              @if (caseForm.get('results')?.hasError('maxlength')) {
                <mat-error>Resultados devem ter no máximo 1000 caracteres</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Informações do Paciente</mat-label>
              <textarea 
                matInput 
                formControlName="patientInfo" 
                rows="2"
                placeholder="Informações relevantes sobre o paciente...">
              </textarea>
              @if (caseForm.get('patientInfo')?.hasError('required')) {
                <mat-error>Informações do paciente são obrigatórias</mat-error>
              }
              @if (caseForm.get('patientInfo')?.hasError('maxlength')) {
                <mat-error>Informações do paciente devem ter no máximo 500 caracteres</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Imagens Adicionais -->
        <div class="section">
          <h3 class="section-title">
            <mat-icon>photo_library</mat-icon>
            Imagens Adicionais
          </h3>

          <div class="upload-section">
            <div class="upload-area">
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <p class="upload-text">Adicione imagens adicionais do caso clínico</p>
              <button 
                type="button"
                class="btn btn-primary"
                (click)="addImage()">
                <mat-icon>add_photo_alternate</mat-icon>
                Adicionar Imagem
              </button>
            </div>
          </div>

          @if (additionalImages().length > 0) {
            <div class="images-grid">
              @for (image of additionalImages(); track image.id) {
                <div class="image-card">
                  <div class="image-container">
                    <img 
                      [src]="image.imageUrl" 
                      [alt]="image.altText"
                      class="case-image">
                    <div class="image-actions">
                      <button 
                        type="button"
                        class="action-btn"
                        [title]="'Editar imagem'"
                        (click)="editImage(image)">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button 
                        type="button"
                        class="action-btn action-btn-danger"
                        [title]="'Remover imagem'"
                        (click)="removeImage(image)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </div>
                  <div class="image-info">
                    <p class="image-caption">{{ image.caption }}</p>
                    <p class="image-alt">{{ image.altText }}</p>
                    @if (image.isMainImage) {
                      <mat-chip color="accent" selected class="main-image-chip">
                        Imagem Principal
                      </mat-chip>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <!-- Status -->
        <div class="section">
          <h3 class="section-title">
            <mat-icon>visibility</mat-icon>
            Status
          </h3>

          <div class="form-row">
            <mat-checkbox formControlName="isActive" class="status-checkbox">
              Caso ativo (visível no site)
            </mat-checkbox>
          </div>
        </div>

        <!-- Ações -->
        <div class="form-actions">
          <button 
            type="button" 
            (click)="goBack()"
            class="cancel-btn">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>

          <button 
            type="submit"
            class="submit-btn"
            [disabled]="caseForm.invalid || submitting()">
            @if (submitting()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              <mat-icon>{{ isEditMode() ? 'save' : 'add' }}</mat-icon>
            }
            {{ isEditMode() ? 'Salvar Alterações' : 'Criar Caso' }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>